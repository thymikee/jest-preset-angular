"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([["3797"],{5754:function(e,s,n){n.r(s),n.d(s,{frontMatter:()=>c,toc:()=>u,default:()=>p,metadata:()=>i,assets:()=>h,contentTitle:()=>a});var i=JSON.parse('{"id":"guides/esm-support","title":"ESM Support","description":"Jest will take into account of the following things when working with ESM:","source":"@site/versioned_docs/version-15.0/guides/esm-support.md","sourceDirName":"guides","slug":"/guides/esm-support","permalink":"/jest-preset-angular/pr-preview/pr-3422/docs/guides/esm-support","draft":false,"unlisted":false,"editUrl":"https://github.com/thymikee/jest-preset-angular/edit/main/website/versioned_docs/version-15.0/guides/esm-support.md","tags":[],"version":"15.0","lastUpdatedBy":"renovate[bot]","lastUpdatedAt":1760338073000,"frontMatter":{"id":"esm-support","title":"ESM Support"},"sidebar":"docs","previous":{"title":"Angular >=13","permalink":"/jest-preset-angular/pr-preview/pr-3422/docs/guides/angular-13+"},"next":{"title":"JSDOM environment","permalink":"/jest-preset-angular/pr-preview/pr-3422/docs/guides/jsdom-environment"}}'),t=n(4848),r=n(4429),o=n(6346),l=n(6754),d=n(5785);let c={id:"esm-support",title:"ESM Support"},a,h={},u=[{value:"Configure Jest runtime",id:"configure-jest-runtime",level:2},{value:"Configure <code>tsconfig</code>",id:"configure-tsconfig",level:2},{value:"Using ES module values",id:"using-es-module-values",level:3},{value:"Using hybrid module values",id:"using-hybrid-module-values",level:3},{value:"Configure Jest config",id:"configure-jest-config",level:2},{value:"Resolve <code>.mjs/.mts</code> extensions",id:"resolve-mjsmts-extensions",level:2}];function j(e){let s={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(s.admonition,{type:"important",children:[(0,t.jsx)(s.p,{children:"Jest will take into account of the following things when working with ESM:"}),(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://jestjs.io/docs/en/ecmascript-modules",children:"ESM runtime"})}),"\n",(0,t.jsxs)(s.li,{children:["The value of ",(0,t.jsx)(s.code,{children:"module"})," option in tsconfig file is either:","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"Node16/Node18/NodeNext"}),": this ",(0,t.jsx)(s.strong,{children:"MUST"})," go together with ",(0,t.jsx)(s.code,{children:'type: "module"'})," in ",(0,t.jsx)(s.code,{children:"package.json"}),"."]}),"\n",(0,t.jsxs)(s.li,{children:["Otherwise, the value ",(0,t.jsx)(s.strong,{children:"MUST BE"})," one of the ES values, e.g. ",(0,t.jsx)(s.code,{children:"ES2015"}),", ",(0,t.jsx)(s.code,{children:"ES2020"})," etc..."]}),"\n"]}),"\n"]}),"\n"]})]}),"\n",(0,t.jsxs)(s.p,{children:["One can configure ",(0,t.jsx)(s.code,{children:"jest-preset-angular"})," to work with Jest in ESM mode by following the steps below."]}),"\n",(0,t.jsx)(s.admonition,{type:"tip",children:(0,t.jsxs)(s.p,{children:["We have ",(0,t.jsx)(s.a,{href:"https://github.com/thymikee/jest-preset-angular/tree/main/examples",children:(0,t.jsx)(s.strong,{children:"EXAMPLE APPS"})})," which contains base ESM setup to work with Jest and Angular."]})}),"\n","\n",(0,t.jsx)(d.A,{toc:u.slice(0)}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.h2,{id:"configure-jest-runtime",children:"Configure Jest runtime"}),"\n",(0,t.jsxs)(s.admonition,{type:"warning",children:[(0,t.jsx)(s.p,{children:"Jest runtime currently has a few issues related to support ESM:"}),(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Not taking into account of ",(0,t.jsx)(s.code,{children:'type: "module"'})," field in ",(0,t.jsx)(s.code,{children:"package.json"})," yet to run as ESM mode."]}),"\n",(0,t.jsxs)(s.li,{children:["Mocking ES modules are not supported yet, track progress here ",(0,t.jsx)(s.a,{href:"https://github.com/jestjs/jest/pull/10976",children:"https://github.com/jestjs/jest/pull/10976"})]}),"\n"]}),(0,t.jsxs)(s.p,{children:["Overall progress and discussion can be found at ",(0,t.jsx)(s.a,{href:"https://github.com/jestjs/jest/issues/9430",children:"https://github.com/jestjs/jest/issues/9430"})]})]}),"\n",(0,t.jsxs)(s.admonition,{type:"info",children:[(0,t.jsxs)(s.p,{children:["If one is using Jest config in TypeScript, one should install ",(0,t.jsx)(s.code,{children:"ts-node"})," as a dev dependency."]}),(0,t.jsxs)(o.A,{groupId:"npm2yarn",children:[(0,t.jsx)(l.A,{value:"npm",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"\nnpm install -D ts-node\n\n"})})}),(0,t.jsx)(l.A,{value:"yarn",label:"Yarn",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"\nyarn add --dev ts-node\n\n"})})}),(0,t.jsx)(l.A,{value:"pnpm",label:"pnpm",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"\npnpm add -D ts-node\n\n"})})}),(0,t.jsx)(l.A,{value:"bun",label:"Bun",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"\nbun add --dev ts-node\n\n"})})})]})]}),"\n",(0,t.jsxs)(s.p,{children:["Execute Jest with with ",(0,t.jsx)(s.code,{children:"--experimental-vm-modules"})," flag for ",(0,t.jsx)(s.code,{children:"NodeJs"})]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"\nnode --experimental-vm-modules node_modules/jest/bin/jest.js\n\n"})}),"\n",(0,t.jsxs)(s.admonition,{type:"tip",children:[(0,t.jsxs)(s.p,{children:["Alternative way for ",(0,t.jsx)(s.code,{children:"Yarn"})," users:"]}),(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-bash",children:"\nyarn node --experimental-vm-modules $(yarn bin jest)\n\n"})}),(0,t.jsxs)(s.p,{children:["This command will also work if you use ",(0,t.jsx)(s.code,{children:"Yarn Plug'n'Play."})]})]}),"\n",(0,t.jsxs)(s.h2,{id:"configure-tsconfig",children:["Configure ",(0,t.jsx)(s.code,{children:"tsconfig"})]}),"\n",(0,t.jsxs)(s.p,{children:["One can choose ",(0,t.jsx)(s.strong,{children:"EITHER ONE"})," of the following options for ",(0,t.jsx)(s.code,{children:"tsconfig"}),":"]}),"\n",(0,t.jsx)(s.h3,{id:"using-es-module-values",children:"Using ES module values"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-json",metastring:'title="tsconfig.spec.json"',children:'{\n  "compilerOptions": {\n    "module": "ESNext", // or any values starting with "es" or "ES"\n    "target": "ESNext",\n    "esModuleInterop": true\n  }\n}\n'})}),"\n",(0,t.jsx)(s.h3,{id:"using-hybrid-module-values",children:"Using hybrid module values"}),"\n",(0,t.jsxs)(s.admonition,{type:"info",children:[(0,t.jsxs)(s.p,{children:["Hybrid module values requires ",(0,t.jsx)(s.code,{children:"type"})," field in ",(0,t.jsx)(s.code,{children:"package.json"})," to be set explicitly to:"]}),(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"commonjs"})," for ",(0,t.jsx)(s.code,{children:"CommonJS"})," code"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"module"})," for ",(0,t.jsx)(s.code,{children:"ESM"})," code"]}),"\n"]}),(0,t.jsxs)(s.p,{children:["See official TypeScript documentation at ",(0,t.jsx)(s.a,{href:"https://www.typescriptlang.org/docs/handbook/modules/reference.html#node16-node18-nodenext",children:"https://www.typescriptlang.org/docs/handbook/modules/reference.html#node16-node18-nodenext"})]})]}),"\n",(0,t.jsx)(s.admonition,{type:"important",children:(0,t.jsxs)(s.p,{children:["Currently, the code transpiler which is used by ",(0,t.jsx)(s.code,{children:"jest-preset-angular"})," ",(0,t.jsx)(s.strong,{children:"ONLY"})," supports hybrid values with ",(0,t.jsx)(s.code,{children:"isolatedModules: true"})]})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-json",metastring:'title="tsconfig.spec.json"',children:'{\n  "compilerOptions": {\n    "module": "Node16", // or Node18/NodeNext\n    "target": "ESNext",\n    "esModuleInterop": true,\n    "isolatedModules": true\n  }\n}\n'})}),"\n",(0,t.jsx)(s.h2,{id:"configure-jest-config",children:"Configure Jest config"}),"\n",(0,t.jsxs)(s.admonition,{type:"tip",children:[(0,t.jsxs)(s.p,{children:["Jest will attempt to load ",(0,t.jsx)(s.strong,{children:"ESM"})," files from ",(0,t.jsx)(s.code,{children:"node_modules"})," with default ",(0,t.jsx)(s.code,{children:"jest-resolve"})," which usually works for most of the cases.\nHowever, there are cases like Angular libraries ",(0,t.jsx)(s.strong,{children:"ESM"})," built files or ",(0,t.jsx)(s.strong,{children:"ESM"})," files which are outside ",(0,t.jsx)(s.code,{children:"node_modules"})," might not be loaded\ncorrectly."]}),(0,t.jsxs)(s.p,{children:["To fix that, one can use ",(0,t.jsx)(s.code,{children:"moduleNameMapper"})," in jest config to instruct Jest to load the correct ",(0,t.jsx)(s.strong,{children:"ESM"})," files or create a\ncustom Jest ",(0,t.jsx)(s.a,{href:"https://jestjs.io/docs/configuration#resolver-string",children:"resolver"}),"."]})]}),"\n",(0,t.jsxs)(o.A,{groupId:"code-examples",children:[(0,t.jsx)(l.A,{value:"node-<22.18",label:"Node <22.18",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",metastring:'title="jest.config.ts" tab={"label":"Node <22.18"}',children:"import type { Config } from 'jest';\nimport { createEsmPreset } from 'jest-preset-angular/presets';\n\nexport default {\n  //...\n  ...createEsmPreset(),\n  moduleNameMapper: {\n    tslib: 'tslib/tslib.es6.js',\n    '^rxjs': '<rootDir>/node_modules/rxjs/dist/bundles/rxjs.umd.js',\n  },\n} satisfies Config;\n"})})}),(0,t.jsx)(l.A,{value:"node-22.18+",label:"Node 22.18+",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-ts",metastring:'title="jest.config.ts" tab={"label":"Node 22.18+"}',children:"import type { Config } from 'jest';\nimport { createEsmPreset } from 'jest-preset-angular/presets/index.js';\n\nexport default {\n  //...\n  ...createEsmPreset(),\n  moduleNameMapper: {\n    tslib: 'tslib/tslib.es6.js',\n    '^rxjs': '<rootDir>/node_modules/rxjs/dist/bundles/rxjs.umd.js',\n  },\n} satisfies Config;\n"})})})]}),"\n",(0,t.jsxs)(s.h2,{id:"resolve-mjsmts-extensions",children:["Resolve ",(0,t.jsx)(s.code,{children:".mjs/.mts"})," extensions"]}),"\n",(0,t.jsx)(s.admonition,{type:"info",children:(0,t.jsxs)(s.p,{children:["This step is optional and only needed if you are using ",(0,t.jsx)(s.code,{children:".mjs"})," or ",(0,t.jsx)(s.code,{children:".mts"})," extensions in your code."]})}),"\n",(0,t.jsxs)(s.p,{children:["See an example one from ",(0,t.jsx)(s.a,{href:"https://kulshekhar.github.io/ts-jest/docs/guides/esm-support",children:"ts-jest"})]})]})}function p(e={}){let{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(j,{...e})}):j(e)}}}]);